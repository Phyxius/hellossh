# Security

HelloSSH has, broadly speaking three goals:

1. Prevent attackers with software-only access to a machine from extracting private key material.
2. Prevent attackers with hardware access (potentially in addition to software access) from extracting private key material.
3. Prevent attackers with any kind of access from inducing the device into using the key on their behalf.

Like any system, it accomplishes its security goals imperfectly. 

## Key Generation and Storage

HelloSSH exposes only operations made available by the Windows Hello APIs (AKA [`KeyCredentialManager`](https://docs.microsoft.com/en-us/uwp/api/windows.security.credentials.keycredentialmanager?view=winrt-19041) and friends). Windows automatically uses the highest level of protection available on the system to protect these keys. For most systems produced within the last ~5 years (and all OEM-built systems shipped since Microsoft made this a requirement), this means using the [Trusted Platform Module](https://en.wikipedia.org/wiki/Trusted_Platform_Module) to generate and use the keys. 

If a TPM is used, private key material is never available in the host's memory for attackers to steal. It is stored encrypted on disk with a key generated by and known only to the TPM. When the PC wants it to sign a challenge (e.g., for SSH login), it will provide the encrypted key to the TPM and the challenge, and the TPM will decrypt the key, sign the challenge, and return the signature to the PC. You can verify that a TPM is protecting your keys by trying to copy the TPM attestation data from the Key Manager GUI. If it succeeds without error, the TPM is protecting them. Some TPM-enabled PCs don't seem to support attestation, so your keys may be protected even if attestation is unavailable, but there is unfortunately no way to tell that is the case. Also, note that PCs equipped with a firmware TPM (which is most of them) may have the key in memory in some form, as the CPU itself is acting as the TPM rather than a discrete chip; however, the firmware TPM is designed to protect its contents from potentially hostile operating system as much as possible, so this is generally acceptable.

If no TPM is available, Windows will fall back to successively weaker key protection methods. If [Credential Guard](https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-requirements) is available (requires [Virtualization Based Security](https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs)), then keys will be protected with it. This protects them against user-space attackers but not from malicious drivers or system firmware. 

If Credential Guard is unavailable, then keys will be protected in software and will be vulnerable to an attacker that gains administrative access to the PC.

### Key Limitations

1. Keys are always 2048-bit RSA keys. Yes, I would prefer ECDSA or ed25519, but that is what is available. RSA keys are still considered secure as of this writing, so that's not a dealbreaker.
2. The only signature type supported is `rsa-sha2-256`. The default signature type requested by OpenSSH is `rsa-sha2-512`, which will fail. You'll have to configure it to not request that kind, or you won't be able to log in anywhere.
3. Keys are not exportable. Ever. Make sure you have a backup way into any servers. I personally keep a regular SSH key on an offline file store that is added to all my hosts, just in case. 
4. If you change your Windows PIN, reset your TPM, or (depending on your hardware) update your BIOS, your keys might be erased. This probably won't happen during the regular courses of use, but you should always have a backup method to access your servers just in case (see above).
5. You will be prompted to authenticate for *every* use of the key. This can get a little annoying, but Microsoft doesn't provide an option for timed access. 

## Protection Against Software Access

If no TPM is available, an attacker with administrative access or that can supply malicious firmware can likely gain access to your keys. This depends on your specific system configuration and on the features provided by your hardware and Windows. 

If a TPM is used, then it is unlikely that an attacker with any level of access can gain access to key material unless they can exploit the TPM, which is generally considered to be unlikely for most attackers. A firmware TPM is potentially vulnerable to the installation of malicious firmware, but this is again unlikely for most attackers and can be mitigated somewhat with Trusted Boot (e.g., BitLocker) and other platform-specific technologies.

## Protection Against Hardware Access

If no TPM is used, an attacker with hardware access can with near certainty gain access to private keys. 

If a TPM is used, an attacker would have to gain access to the TPM and to your encrypted keys on disk in order to extract the keys. For most firmware and hardware TPMs, this is generally considered unlikely and can be further hardened by using BitLocker and other platform-specific technologies that protect system firmware.

## Protection Against Unauthorized Use

In all cases, an attacker with administrative access to the PC can probably induce it to sign challenges on their behalf. HelloSSH attempts to make this at least *visible* by notifying you when challenges are requested, but an attacker may be able to bypass HelloSSH and talk to the underlying APIs directly. They could also likely keylog your PIN in order to authenticate to Windows Hello on your behalf. However, as discussed above this is online only and may not allow them to actually export the key material.

## Summary

HelloSSH when used with a TPM provides significant protection against attackers whose goal is to export private keys for offline use, and reasonably strong protection against attackers whose goal is to simply induce the device to sign challenges on their behalf. If no TPM is available, HelloSSH provides as much security as Windows can provide, which is limited.
